name: Build luci-app-zzz

on:
  workflow_dispatch:
    inputs:
      sdk:
        description: 'é€‰æ‹©æ¶æ„'
        required: true
        type: choice
        options:
          - ramips
          - filogic
          - x86_64
        default: filogic

env:
  RAMIPS_SDK_URL: https://downloads.immortalwrt.org/releases/24.10.3/targets/ramips/mt7621/immortalwrt-sdk-24.10.3-ramips-mt7621_gcc-13.3.0_musl.Linux-x86_64.tar.zst
  FILOGIC_SDK_URL: https://downloads.immortalwrt.org/releases/24.10.3/targets/mediatek/filogic/immortalwrt-sdk-24.10.3-mediatek-filogic_gcc-13.3.0_musl.Linux-x86_64.tar.zst
  X86_SDK_URL:  https://downloads.immortalwrt.org/releases/24.10.3/targets/x86/64/immortalwrt-sdk-24.10.3-x86-64_gcc-13.3.0_musl.Linux-x86_64.tar.zst

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          echo "ğŸ‘‰ æ­£åœ¨ä¸‹è½½ä¾èµ–é¡¹"
          sudo apt-get update
          sudo apt-get install -y build-essential git wget python3 rsync zstd g++ make libncurses-dev
          echo "âœ… ä¸‹è½½å®Œæ¯•"

      - name: Resolve SDK choice
        id: vars
        run: |
          set -e
          if [ "${{ github.event.inputs.sdk }}" = "x86_64" ]; then
            echo "SDK_URL=${X86_SDK_URL}" >> $GITHUB_ENV
            echo "PACKAGE_ARCH=x86_64" >> $GITHUB_ENV
            echo "ğŸ‘‰ é€‰æ‹©x86_64æ¶æ„"
          elif [ "${{ github.event.inputs.sdk }}" = "filogic" ]; then
            echo "SDK_URL=${FILOGIC_SDK_URL}" >> $GITHUB_ENV
            echo "PACKAGE_ARCH=aarch64_cortex-a53" >> $GITHUB_ENV
            echo "ğŸ‘‰ é€‰æ‹©aarch64æ¶æ„"
          else
            echo "SDK_URL=${RAMIPS_SDK_URL}" >> $GITHUB_ENV
            echo "PACKAGE_ARCH=ramips" >> $GITHUB_ENV
            echo "ğŸ‘‰ é€‰æ‹©ramipsæ¶æ„"
          fi
          echo "WORK_ROOT=$GITHUB_WORKSPACE/imwrt-sdk" >> $GITHUB_ENV

      - name: Download & extract SDK
        run: |
          set -euo pipefail
          mkdir -p "$WORK_ROOT"
          cd "$WORK_ROOT"

          SDK_TAR="$(basename "$SDK_URL")"
          echo "ğŸ‘‰ æ­£åœ¨ä¸‹è½½SDKï¼š$SDK_TAR"
          wget -q "$SDK_URL" -O "$SDK_TAR"

          echo "ğŸ“¦ æ­£åœ¨è§£å‹SDK..."
          tar --use-compress-program="zstd -q -d" -xf "$SDK_TAR" >/dev/null 2>&1

          echo "âœ… SDKè§£å‹å®Œæˆ"
          SDK_ROOT="$(find . -maxdepth 1 -type d -name 'immortalwrt-sdk*' | head -n 1)"
          if [ -z "$SDK_ROOT" ]; then
            echo "âŒ æœªæ‰¾åˆ°SDKç›®å½•" >&2
            exit 1
          fi
          SDK_ROOT="$(cd "$SDK_ROOT" && pwd)"
          echo "SDK_ROOT=$SDK_ROOT" >> $GITHUB_ENV
          echo "ğŸ“ SDKè·¯å¾„: $SDK_ROOT"

      - name: Setup feeds & clone source
        run: |
          set -euo pipefail
          cd "$SDK_ROOT"
          echo "ğŸ‘‰ æ­£åœ¨è®¾ç½®feeds"
          ./scripts/feeds update -a
          ./scripts/feeds update luci || true
          ./scripts/feeds install -a -p luci || ./scripts/feeds install luci || true
          echo "âœ… feedsä¸‹è½½å®Œæ¯•"
          cd package
          git clone https://github.com/Dichgrem/luci-app-nyn.git
          cp -r luci-app-nyn/luci-app-zzz . 2>/dev/null || true
          cp -r luci-app-nyn/zzz . 2>/dev/null || true
          rm -rf luci-app-nyn

      - name: Build luci-app-zzz
        run: |
          set -euo pipefail
          cd "$SDK_ROOT"
          make defconfig
          echo "ğŸ‘‰ æ­£åœ¨ç¼–è¯‘ä¸­"
          make package/luci-app-zzz/compile V=s
          echo "âœ… ç¼–è¯‘å®Œæˆ"

      - name: Collect packages
        run: |
          set -euo pipefail
          SDK_ROOT="$SDK_ROOT"
          OUT="$GITHUB_WORKSPACE/output"
          mkdir -p "$OUT"

          echo "ğŸ” è‡ªåŠ¨æ£€æµ‹ SDK åŒ…æ¶æ„ç›®å½•..."
          BASE_DIR=$(find "$SDK_ROOT/bin/packages" -type d -path "*/base" | head -n1 || true)
          if [ -z "$BASE_DIR" ]; then
            echo "âŒ æœªæ‰¾åˆ° base ç›®å½•" >&2
            ls -R "$SDK_ROOT/bin/packages" || true
            exit 1
          fi

          echo "ğŸ“¦ ä»: $BASE_DIR æ”¶é›† luci-app-zzz ä¸ zzz åŒ…..."
          ls -lah "$BASE_DIR" || true

          cp -v "$BASE_DIR"/*luci-app-zzz*.ipk "$OUT"/ 2>/dev/null || true
          cp -v "$BASE_DIR"/*zzz*.ipk "$OUT"/ 2>/dev/null || true

          echo "âœ… æ”¶é›†å®Œæˆï¼Œè¾“å‡ºç›®å½•å†…å®¹ï¼š"
          ls -lah "$OUT"
        shell: bash

      - name: Upload package one
        uses: actions/upload-artifact@v4
        with:
          name: luci-app-zzz
          path: output/*luci-app-zzz*.ipk
          if-no-files-found: error

      - name: Upload package two
        uses: actions/upload-artifact@v4
        with:
          name: zzz
          path: output/*zzz*.ipk
          if-no-files-found: error
